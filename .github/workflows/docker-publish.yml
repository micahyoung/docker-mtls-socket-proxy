name: Docker

on:
  push:
    # Publish `main` as Docker `latest` image.
    branches:
      - main

    # Publish `v1.2.3` tags as releases.
    tags:
      - v*

  # Run tests for any PRs.
  pull_request:
    branches:
      - main
jobs:
  push-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Enable docker binfmt_misc for ARM image support
        run: |
          set -o errexit -o pipefail -o nounset
          
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Build arm64 images
        env:
          IMAGE_NAME: docker-mtls-socket-proxy:alpine-arm64
          BUILD_IMAGE_REF: golang@sha256:90c23e39762d5ac1af14fb6ffc27c1f310c43087172a83ae02f7cfc7c498384f
          RUN_IMAGE_REF: alpine@sha256:b20140108af597a58a06ed5578f2a5737b8ad9964a206b5627d2cda906613665
          PLATFORM: linux/arm64
        run: |
          set -o errexit -o pipefail -o nounset

          docker pull $BUILD_IMAGE_REF
          docker pull $RUN_IMAGE_REF

          docker build . --build-arg BUILD_IMAGE=$BUILD_IMAGE_REF --build-arg RUN_IMAGE=$RUN_IMAGE_REF --file Dockerfile.linux --tag $IMAGE_NAME

      - name: Build amd64 images
        env:
          IMAGE_NAME: docker-mtls-socket-proxy:alpine-amd64
          BUILD_IMAGE_REF: golang@sha256:837f776dad3314b28bdcb4bba4cdf359275a3656424eda52b88a68735c38f48c
          RUN_IMAGE_REF: alpine@sha256:d0710affa17fad5f466a70159cc458227bd25d4afb39514ef662ead3e6c99515
          PLATFORM: linux/amd64
        run: |
          set -o errexit -o pipefail -o nounset

          docker pull $BUILD_IMAGE_REF
          docker pull $RUN_IMAGE_REF

          docker build . --build-arg BUILD_IMAGE=$BUILD_IMAGE_REF --build-arg RUN_IMAGE=$RUN_IMAGE_REF --file Dockerfile.linux --tag $IMAGE_NAME

      - name: Test amd64
        env:
          IMAGE_NAME: docker-mtls-socket-proxy:alpine-amd64
        run: |
          docker run --detach \
              --name tlsproxy \
              --publish 23760:2376 \
              --volume $HOME/.docker:/certs \
              --volume /var/run/docker.sock:/var/run/docker.sock \
              --restart always \
              $IMAGE_NAME
              
          docker logs -f tlsproxy &
          
          # wait for certs to be generated
          sleep 20
          
          # Test connection
          export DOCKER_HOST="tcp://localhost:23760"
          export DOCKER_TLS_VERIFY="1"
          export DOCKER_CERT_PATH="$HOME/.docker"

          docker info

          docker -H unix:///var/run/docker.sock rm -f tlsproxy

          rm -rf $HOME/.docker/*.pem

      - name: Test arm64
        env:
          IMAGE_NAME: docker-mtls-socket-proxy:alpine-arm64 
        run: |
          docker run --detach \
              --name tlsproxy \
              --publish 23760:2376 \
              --volume $HOME/.docker:/certs \
              --volume /var/run/docker.sock:/var/run/docker.sock \
              --restart always \
              $IMAGE_NAME
              
          docker logs -f tlsproxy &
          
          # wait for certs to be generated
          sleep 20
          
          # Test connection
          export DOCKER_HOST="tcp://localhost:23760"
          export DOCKER_TLS_VERIFY="1"
          export DOCKER_CERT_PATH="$HOME/.docker"

          docker info

          docker -H unix:///var/run/docker.sock rm -f tlsproxy
       
          rm -rf $HOME/.docker/*.pem
          
      - name: Log into registry
        if: github.event_name == 'push'
        run: |
          echo ${{ secrets.CR_PAT }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push arm64 image
        if: github.event_name == 'push'
        env:
          IMAGE_NAME: docker-mtls-socket-proxy:alpine-arm64
        run: |
          IMAGE_ID=ghcr.io/${{ github.repository }}:alpine-arm64

          echo IMAGE_ID=$IMAGE_ID

          docker tag $IMAGE_NAME $IMAGE_ID
          docker push $IMAGE_ID

      - name: Push amd64 image
        if: github.event_name == 'push'
        env:
          IMAGE_NAME: docker-mtls-socket-proxy:alpine-amd64
        run: |
          IMAGE_ID=ghcr.io/${{ github.repository }}:alpine-amd64

          echo IMAGE_ID=$IMAGE_ID

          docker tag $IMAGE_NAME $IMAGE_ID
          docker push $IMAGE_ID

  push-windows:
    runs-on: windows-latest
    env:
      IMAGE_OS: nanoserver-1809
    steps:
      - uses: actions/checkout@v2
      - name: Build image
        run: docker build . --file Dockerfile.windows --tag docker-mtls-socket-proxy:nanoserver-amd64 --build-arg os_tag=1809

      - name: Test
        run: |
          docker run --detach `
              --name tlsproxy `
              --publish 23760:2376 `
              --volume $env:USERPROFILE\.docker:c:/certs `
              --volume \\.\pipe\docker_engine:\\.\pipe\docker_engine `
              --restart always `
              docker-mtls-socket-proxy:nanoserver-amd64

          Start-Process -NoNewWindow -FilePath docker -ArgumentList "logs -f tlsproxy"
 
          # wait for certs to be generated
          Start-Sleep 45

          # Test connection
          $env:DOCKER_HOST="tcp://localhost:23760"
          $env:DOCKER_TLS_VERIFY="1"
          $env:DOCKER_CERT_PATH="$env:USERPROFILE\.docker"
          
          docker info
          
          docker -H npipe:////./pipe/docker_engine rm -f tlsproxy
          
      - name: Log into registry
        if: github.event_name == 'push'
        run: |
          echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push image
        if: github.event_name == 'push'
        run: |
          $IMAGE_ID="ghcr.io/${{ github.repository }}:nanoserver-amd64"

          echo IMAGE_ID=${IMAGE_ID}

          docker tag docker-mtls-socket-proxy:nanoserver-amd64 "ghcr.io/${{ github.repository }}:${env:IMAGE_OS}-amd64"
          docker push ${IMAGE_ID}
